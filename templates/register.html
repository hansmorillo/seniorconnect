{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/register.css') }}">
<style>
/* Professional Password Strength Indicator - Extends existing register.css */
.password-strength-container {
  margin-top: 8px;
}

.password-strength-bar {
  width: 100%;
  height: 6px;
  background-color: #e5e7eb;
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 12px;
  position: relative;
  box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
}

.password-strength-fill {
  height: 100%;
  width: 0%;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border-radius: 3px;
  position: relative;
}

.strength-very-weak { 
  background: linear-gradient(90deg, #ef4444, #dc2626); 
  box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
}
.strength-weak { 
  background: linear-gradient(90deg, #f97316, #ea580c);
  box-shadow: 0 0 8px rgba(249, 115, 22, 0.3);
}
.strength-fair { 
  background: linear-gradient(90deg, #eab308, #ca8a04);
  box-shadow: 0 0 8px rgba(234, 179, 8, 0.3);
}
.strength-good { 
  background: linear-gradient(90deg, #22c55e, #16a34a);
  box-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
}
.strength-strong { 
  background: linear-gradient(90deg, #10b981, #059669);
  box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
}

.password-strength-text {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 10px;
  transition: color 0.3s ease;
  text-align: center;
  letter-spacing: 0.3px;
}

.strength-text-very-weak { color: #dc2626; }
.strength-text-weak { color: #ea580c; }
.strength-text-fair { color: #ca8a04; }
.strength-text-good { color: #16a34a; }
.strength-text-strong { color: #059669; }

/* Enhanced Password Requirements - Building on existing styles */
.password-requirements {
  margin-top: 12px;
  padding: 16px;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  font-size: 13px;
  transition: all .3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.password-requirements h4 {
  margin: 0 0 14px 0;
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

.password-requirements h4::before {
  content: "ðŸ”’";
  font-size: 16px;
}

.requirement {
  display: flex;
  align-items: center;
  margin: 10px 0;
  color: var(--muted);
  transition: all .3s cubic-bezier(0.4, 0, 0.2, 1);
  padding: 6px 8px;
  border-radius: 6px;
}

.requirement:last-child {
  margin-bottom: 0;
}

.requirement.valid {
  color: var(--success);
  background: rgba(22, 163, 74, 0.08);
  transform: translateX(2px);
}

.requirement.invalid {
  color: var(--danger);
  background: rgba(220, 38, 38, 0.06);
}

.requirement-icon {
  width: 20px;
  height: 20px;
  margin-right: 12px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: bold;
  transition: all .3s cubic-bezier(0.4, 0, 0.2, 1);
  flex-shrink: 0;
  border: 2px solid transparent;
}

.requirement.valid .requirement-icon {
  background: var(--success);
  color: white;
  transform: scale(1.1);
  box-shadow: 0 2px 8px rgba(22, 163, 74, 0.3);
}

.requirement.invalid .requirement-icon {
  background: #f3f4f6;
  color: var(--danger);
  border-color: #fee2e2;
}

.requirement span {
  font-weight: 500;
  transition: font-weight 0.2s ease;
}

.requirement.valid span {
  font-weight: 600;
}

/* Pulse animation for newly satisfied requirements */
@keyframes satisfyRequirement {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.requirement.just-satisfied {
  animation: satisfyRequirement 0.5s ease-out;
}

/* Enhanced focus styles */
.form-input:focus + .password-strength-container {
  opacity: 1;
}

.password-strength-container {
  opacity: 0.9;
  transition: opacity 0.3s ease;
}

/* reCAPTCHA container styling */
.captcha-container {
  margin: 20px 0;
  display: flex;
  justify-content: center;
  min-height: 78px; /* Reserve space for reCAPTCHA */
}

.captcha-container .g-recaptcha {
  display: inline-block;
}

/* Mobile responsiveness */
@media (max-width: 480px) {
  .password-requirements {
    padding: 12px;
  }
  
  .requirement-icon {
    width: 18px;
    height: 18px;
    font-size: 10px;
    margin-right: 10px;
  }
  
  .password-strength-text {
    font-size: 12px;
  }
  
  .captcha-container {
    transform: scale(0.85);
    transform-origin: center;
  }
}
</style>
{% endblock %}

{% block content %}
<section class="split-auth">
  <!-- LEFT: form panel -->
  <div class="auth-left">
    <div class="brand-row">
      <!-- Optional: replace with your logo -->
      <span class="brand">SeniorConnect</span>
    </div>

    <h1 class="title">Create your account</h1>
    <p class="subtitle">Please fill in your details to continue</p>

    <form method="post" action="{{ url_for('auth.register') }}" class="auth-form" id="registerForm">
      {{ form.hidden_tag() }}

      <div class="form-group">
        <label class="form-label">{{ form.display_name.label }}</label>
        {{ form.display_name(class="form-input") }}
        {% for e in form.display_name.errors %}<div class="error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-group">
        <label class="form-label">{{ form.email.label }}</label>
        {{ form.email(class="form-input") }}
        {% for e in form.email.errors %}<div class="error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-group">
        <label class="form-label">{{ form.phone.label }}</label>
        {{ form.phone(class="form-input") }}
        {% for e in form.phone.errors %}<div class="error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-group">
        <label class="form-label">{{ form.password.label }}</label>
        {{ form.password(class="form-input", id="passwordField") }}
        {% for e in form.password.errors %}<div class="error">{{ e }}</div>{% endfor %}
        
        <!-- Password Strength Indicator -->
        <div class="password-strength-container" id="passwordStrengthContainer" style="display: none;">
          <div class="password-strength-text" id="strengthText">Password Strength</div>
          <div class="password-strength-bar">
            <div class="password-strength-fill" id="strengthFill"></div>
          </div>
        </div>
        
        <!-- Password Requirements -->
        <div class="password-requirements" id="passwordRequirements" style="display: none;">
          <h4>Password Requirements</h4>
          <div class="requirement" id="req-length">
            <div class="requirement-icon">âœ—</div>
            <span>At least 8 characters long</span>
          </div>
          <div class="requirement" id="req-uppercase">
            <div class="requirement-icon">âœ—</div>
            <span>At least one uppercase letter (A-Z)</span>
          </div>
          <div class="requirement" id="req-lowercase">
            <div class="requirement-icon">âœ—</div>
            <span>At least one lowercase letter (a-z)</span>
          </div>
          <div class="requirement" id="req-number">
            <div class="requirement-icon">âœ—</div>
            <span>At least one number (0-9)</span>
          </div>
          <div class="requirement" id="req-special">
            <div class="requirement-icon">âœ—</div>
            <span>At least one special character (@$!%*?&)</span>
          </div>
        </div>
      </div>

      <!-- Fixed reCAPTCHA using Flask-WTF -->
      <div class="captcha-container">
        {{ form.recaptcha }}
      </div>
      {% for e in form.recaptcha.errors %}
        <div class="error">{{ e }}</div>
      {% endfor %}

      {% if form.csrf_token.errors %}
        <div class="error">
          {% for e in form.csrf_token.errors %}{{ e }}{% if not loop.last %}<br>{% endif %}{% endfor %}
        </div>
      {% endif %}

      {{ form.submit(class="btn btn-primary") }}
    </form>

    <p class="auth-footer">
      Already have an account?
      <a href="{{ url_for('auth.login') }}">Log in</a>
    </p>
  </div>

  <!-- RIGHT: image panel -->
  <aside class="auth-right"
         style="--hero:url('{{ url_for('static', filename='images/auth-hero.jpg') }}')">
    <div class="hero-copy">
      <h2>Bring your ideas to life.</h2>
      <p>Sign up and enjoy access to events and community features.</p>
    </div>
  </aside>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const passwordField = document.getElementById('passwordField');
  const requirementsDiv = document.getElementById('passwordRequirements');
  const strengthContainer = document.getElementById('passwordStrengthContainer');
  const strengthFill = document.getElementById('strengthFill');
  const strengthText = document.getElementById('strengthText');
  
  const requirements = {
    length: { id: 'req-length', test: password => password.length >= 8 },
    uppercase: { id: 'req-uppercase', test: password => /[A-Z]/.test(password) },
    lowercase: { id: 'req-lowercase', test: password => /[a-z]/.test(password) },
    number: { id: 'req-number', test: password => /\d/.test(password) },
    special: { id: 'req-special', test: password => /[@$!%*?&]/.test(password) }
  };
  
  passwordField.addEventListener('focus', function() {
    requirementsDiv.style.display = 'block';
    strengthContainer.style.display = 'block';
  });
  
  passwordField.addEventListener('input', function() {
    const password = this.value;
    let satisfiedCount = 0;
    let strengthScore = 0;
    
    // Check each requirement
    for (const [key, requirement] of Object.entries(requirements)) {
      const isValid = requirement.test(password);
      updateRequirement(requirement.id, isValid);
      if (isValid) {
        satisfiedCount++;
        strengthScore += 20;
      }
    }
    
    // Bonus points for length
    if (password.length >= 12) strengthScore += 10;
    if (password.length >= 16) strengthScore += 10;
    
    // Penalty for common patterns
    if (/123|abc|password|qwerty|111|000/i.test(password)) {
      strengthScore -= 20;
    }
    
    // Update strength bar
    updateStrengthBar(Math.min(strengthScore, 100), satisfiedCount);
  });
  
  function updateRequirement(reqId, isValid) {
    const requirement = document.getElementById(reqId);
    const icon = requirement.querySelector('.requirement-icon');
    const wasValid = requirement.classList.contains('valid');
    
    if (isValid && !wasValid) {
      // Just became valid - add animation
      requirement.classList.add('just-satisfied');
      setTimeout(() => {
        requirement.classList.remove('just-satisfied');
      }, 500);
    }
    
    if (isValid) {
      requirement.classList.remove('invalid');
      requirement.classList.add('valid');
      icon.textContent = 'âœ“';
    } else {
      requirement.classList.remove('valid');
      requirement.classList.add('invalid');
      icon.textContent = 'âœ—';
    }
  }
  
  function updateStrengthBar(score, satisfiedCount) {
    let strengthLevel, strengthClass, strengthLabel;
    
    if (score < 20) {
      strengthLevel = 20;
      strengthClass = 'strength-very-weak';
      strengthLabel = 'Very Weak';
    } else if (score < 40) {
      strengthLevel = 40;
      strengthClass = 'strength-weak';
      strengthLabel = 'Weak';
    } else if (score < 60) {
      strengthLevel = 60;
      strengthClass = 'strength-fair';
      strengthLabel = 'Fair';
    } else if (score < 80) {
      strengthLevel = 80;
      strengthClass = 'strength-good';
      strengthLabel = 'Good';
    } else {
      strengthLevel = 100;
      strengthClass = 'strength-strong';
      strengthLabel = 'Strong';
    }
    
    // Update bar fill
    strengthFill.style.width = strengthLevel + '%';
    strengthFill.className = 'password-strength-fill ' + strengthClass;
    
    // Update text
    strengthText.textContent = `Password Strength: ${strengthLabel}`;
    strengthText.className = 'password-strength-text strength-text-' + strengthClass.replace('strength-', '');
    
    // Special message for perfect score
    if (satisfiedCount === 5 && score >= 80) {
      strengthText.textContent = `Password Strength: ${strengthLabel} ðŸŽ‰`;
    }
  }
  
  // Form validation before submit
  document.getElementById('registerForm').addEventListener('submit', function(e) {
    // Check if reCAPTCHA is available and get response
    if (typeof grecaptcha !== 'undefined') {
      const recaptchaResponse = grecaptcha.getResponse();
      
      if (!recaptchaResponse) {
        e.preventDefault();
        alert('Please complete the reCAPTCHA verification');
        return false;
      }
      
      console.log('Form submitting with reCAPTCHA response:', recaptchaResponse.substring(0, 20) + '...');
    }
  });
});

// reCAPTCHA callback functions (optional but recommended)
function onRecaptchaLoad() {
  console.log('reCAPTCHA loaded successfully');
}

function onRecaptchaExpire() {
  console.log('reCAPTCHA expired, user needs to solve again');
}

function onRecaptchaError() {
  console.log('reCAPTCHA error occurred');
}
</script>

{% endblock %}