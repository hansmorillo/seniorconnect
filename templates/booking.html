{% extends "base.html" %}
{% block content %}

<!-- Banner -->
<div class="banner-wrapper">
  <img src="{{ url_for('static', filename='images/booking.jpg') }}" alt="Banner" class="banner-image">
</div>

<!-- Custom Alert Container -->
<div id="customAlertContainer" class="position-fixed top-0 start-50 translate-middle-x mt-4" style="z-index: 1055; max-width: 600px;"></div>
<!-- Floating Form Wrapper -->
<div class="form-overlay-wrapper px-0">
  <div class="booking-form-wrapper d-flex flex-column">

    <!-- Tabs -->
    <div class="tab-container">
      <div class="row gx-0">
        <div class="col text-center"><a class="tab-box active-tab" id="tabLocation" data-tab="location">Location</a></div>
        <div class="col text-center"><a class="tab-box" id="tabDatetime" data-tab="datetime">Date & Time</a></div>
        <div class="col text-center"><a class="tab-box" id="tabDetails" data-tab="details">Event Details</a></div>
        <div class="col text-center"><a class="tab-box" id="tabOrganiser" data-tab="organiser">Organiser</a></div>
        <div class="col text-center"><a class="tab-box" id="tabConfirmation" data-tab="confirmation">Confirmation</a></div>
      </div>
    </div>

    <!-- Progress Indicator -->
    <div id="progressWrapper" class="progress-steps-container mt-5 mb-4 px-5">
      <div class="progress-line position-relative" style="height: 6px; background-color: #e0e0e0; border-radius: 3px;">
        <div class="progress-fill" id="progressFill" style="position: absolute; top: 0; left: 0; height: 6px; background-color: #0d6efd; border-radius: 3px; width: 0%; transition: width 0.4s ease;"></div>
        <div class="d-flex justify-content-between position-absolute w-100" style="top: -12px;">
          {% for i in range(5) %}
            <div class="step-circle" id="stepCircle{{ i }}"></div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Location Section -->
    <div id="locationSection" class="flex-grow-1 d-flex align-items-start justify-content-center flex-column pt-5 pb-4">
    <div class="container text-center mt-4">
        <div class="row justify-content-center">
        <!-- Card 1 -->
        <div class="col-md-3 mx-4 custom-card">
            <img src="{{ url_for('static', filename='images/sports_hall.jpg') }}" class="rounded-circle card-img-top mb-3" alt="Sports Hall" style="width: 100px; height: 100px; object-fit: cover;">
            <h5>Indoor Sports Hall</h5>
            <button class="btn btn-outline-dark btn-sm mb-1" data-bs-toggle="modal" data-bs-target="#locationInfoModal">More info</button>
            <p class="mb-2">For Large-scale Events</p>
            <button class="btn btn-outline-primary btn-sm select-btn">Select</button>
        </div>

        <!-- Card 2 -->
        <div class="col-md-3 mx-4 custom-card">
            <img src="{{ url_for('static', filename='images/function_room.jpg') }}" class="rounded-circle card-img-top mb-3" alt="Function Room" style="width: 100px; height: 100px; object-fit: cover;">
            <h5>Function Room</h5>
            <button class="btn btn-outline-dark btn-sm mb-1" data-bs-toggle="modal" data-bs-target="#locationInfoModal">More info</button>
            <p class="mb-2">For Small-scale Events</p>
            <button class="btn btn-outline-primary btn-sm select-btn">Select</button>
        </div>

        <!-- Card 3 -->
        <div class="col-md-3 mx-4 custom-card">
            <img src="{{ url_for('static', filename='images/multipurpose.jpg') }}" class="rounded-circle card-img-top mb-3" alt="Multipurpose Hall" style="width: 100px; height: 100px; object-fit: cover;">
            <h5>Multi-purpose Hall</h5>
            <button class="btn btn-outline-dark btn-sm mb-1" data-bs-toggle="modal" data-bs-target="#locationInfoModal">More info</button>
            <p class="mb-2">For Medium-scale Events</p>
            <button class="btn btn-outline-primary btn-sm select-btn">Select</button>
        </div>
        </div>

        <!-- Continue Button -->
        <div class="mt-5">
        <button id="continueBtn" class="btn btn-custom-continue rounded-pill px-5 py-2 fs-5">Continue</button>
        <div id="errorMsg" class="text-danger mt-2 d-none">Please select a location first.</div>
        </div>
    </div>
    </div>


    <!-- Date & Time Section -->
    <div id="datetimeSection" class="d-none flex-grow-1 pt-5 pb-4">
        <div class="container">

            <!-- Date Selection -->
            <div class="mb-5">
                <label class="fw-semibold mb-3 d-block section-label-lg">Select a Date</label>
                <div class="d-flex justify-content-center">
                    <div class="custom-calendar-wrapper p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button id="prevMonth" class="btn btn-sm btn-outline-secondary px-2 py-0 fs-5">&lt;</button>
                            <div id="monthYear" class="fw-bold"></div>
                            <button id="nextMonth" class="btn btn-sm btn-outline-secondary px-2 py-0 fs-5">&gt;</button>
                        </div>
                        <table class="table table-borderless text-center mb-0">
                            <thead class="text-muted">
                                <tr>
                                    <th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th>
                                </tr>
                            </thead>
                            <tbody id="calendar-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Time Slot Selection -->
            <div>
              <label class="fw-semibold mb-3 d-block section-label-lg">Select a Time Slot</label>

              <!-- Dynamic container -->
              <div id="timeSlotContainer">
                <!-- Morning -->
                <div id="morningSlots" class="mb-3 d-none">
                    <div class="fw-semibold mb-2">Morning</div>
                    <div class="d-flex flex-wrap gap-3" id="morningSlotButtons"></div>
                </div>

                <!-- Afternoon -->
                <div id="afternoonSlots" class="mb-3 d-none">
                    <div class="fw-semibold mb-2">Afternoon</div>
                    <div class="d-flex flex-wrap gap-3" id="afternoonSlotButtons"></div>
                </div>

                <!-- Evening -->
                <div id="eveningSlots" class="mb-3 d-none">
                    <div class="fw-semibold mb-2">Evening</div>
                    <div class="d-flex flex-wrap gap-3" id="eveningSlotButtons"></div>
                </div>
            </div>
        </div>
            <!-- Continue Button -->
            <div class="mt-5 text-center">
                <button id="datetimeContinueBtn" class="btn btn-custom-continue rounded-pill px-5 py-2 fs-5">Continue</button>
            </div>

        </div>
    </div>

    <!-- Event Details Section -->
    <div id="detailsSection" class="d-none">
      <div class="container px-4">

        <h4 class="mb-4 fw-semibold">Event Details</h4>

        <!-- Event Info -->
        <div class="card p-4 mb-4 bg-light shadow-sm border-0">
          <h5 class="fw-semibold mb-3">Event Info</h5>

          <!-- Event Title -->
          <div class="mb-4">
            <label for="eventTitle" class="form-label fw-semibold">Event Title</label>
            <input type="text" id="eventTitle" class="form-control" placeholder="e.g. Yoga Workshop">
          </div>

          <!-- Interest Group -->
          <div>
            <label for="interestGroup" class="form-label fw-semibold">Interest Group</label>
            <select id="interestGroup" class="form-select">
              <option selected disabled>Choose your interest group</option>
              <option>Yoga</option>
              <option>Chess</option>
              <option>Taichi</option>
              <option>Mahjong</option>
              <option>Gardening</option>
            </select>
          </div>
        </div>

        <!-- Event Logistics -->
        <div class="card p-4 bg-light shadow-sm border-0">
          <h5 class="fw-semibold mb-3">Event Logistics</h5>

          <div class="row">
            <!-- Expected Number of Attendees -->
            <div class="col-md-6 mb-4">
              <label for="attendees" class="form-label fw-semibold">Expected Number of Attendees</label>
              <input type="number" id="attendees" class="form-control" min="1" placeholder="e.g. 30">
            </div>

            <!-- Type of Activity -->
            <div class="col-md-6 mb-4">
              <label for="activityType" class="form-label fw-semibold">Type of Activity</label>
              <select id="activityType" class="form-select">
                <option selected disabled>Select an activity type</option>
                <option>Workshop</option>
                <option>Talk</option>
                <option>Performance</option>
                <option>Hands-on Session</option>
                <option>Meeting</option>
                <option>Event</option>
                <option>Others</option>
              </select>
            </div>
          </div>

          <!-- Equipment Required -->
          <div class="mb-4">
            <label for="equipment" class="form-label fw-semibold">Equipment Required (Optional)</label>
            <textarea id="equipment" class="form-control" rows="3" placeholder="List any equipment you will need in the following format: E.g. - Microphone x2"></textarea>
          </div>

          <!-- Description (Optional) -->
          <div>
            <label for="description" class="form-label fw-semibold">Short Description <span class="text-muted">(Optional)</span></label>
            <textarea id="description" class="form-control" rows="3" placeholder="Provide any additional details about the event..."></textarea>
          </div>
        </div>

        <!-- Continue Button -->
        <div class="mt-5 text-center">
          <button id="detailsContinueBtn" class="btn btn-custom-continue rounded-pill px-5 py-2 fs-5">Continue</button>
        </div>

      </div>
    </div>

  <!-- Organiser Section -->
  <div id="organiserSection" class="d-none">
    <div class="container px-4">
      <h4 class="mb-4 fw-semibold">Organiser Details</h4>

      <div class="card p-4 bg-light shadow-sm border-0">
        <div class="mb-4">
          <label for="organiserName" class="form-label fw-semibold">Organiser Name</label>
          <input type="text" id="organiserName" class="form-control" placeholder="e.g. Tan Mei Ling">
        </div>

        <div class="mb-4">
          <label for="organiserEmail" class="form-label fw-semibold">Organiser Email</label>
          <input type="email" id="organiserEmail" class="form-control" placeholder="e.g. example@email.com">
        </div>

        <div class="mb-4">
          <label for="organiserPhone" class="form-label fw-semibold">Organiser Phone</label>
          <input type="tel" id="organiserPhone" class="form-control" placeholder="e.g. 91234567">
        </div>

        <!-- Accessibility or Setup Help -->
        <div class="mb-4">
          <label class="form-label d-block mb-3 fw-semibold">Accessibility or Setup Help Required?</label>
          <div class="d-flex gap-3 flex-wrap">
            <input type="radio" class="btn-check" name="accessibilityHelp" id="helpYes" autocomplete="off" value="Yes">
            <label class="btn btn-outline-dark rounded-pill px-4 py-2" for="helpYes">Yes</label>

            <input type="radio" class="btn-check" name="accessibilityHelp" id="helpNo" autocomplete="off" value="No">
            <label class="btn btn-outline-dark rounded-pill px-4 py-2" for="helpNo">No</label>
          </div>
        </div>
      </div>
    </div>
    <div class="text-center mt-5">
      <button id="organiserContinueBtn" class="btn btn-custom-continue rounded-pill px-5 py-2 fs-5">Continue</button>
    </div>    
  </div>

  <!--Confirmation Section-->
  <div id="confirmationSection" class="d-none container my-5">
    <h2 class="text-center mb-4" style="font-size: 2rem;">You're almost there!</h2>
    <h5 class="text-center mb-4"">Please confirm details of your booking and proceed by clicking the Confirm Booking button.</h2>

    <div class="p-4 rounded shadow-sm" style="background-color: #f8f9fc;"> <!-- card wrapper bg like location cards -->
      <div class="row">
        <!-- Left Column -->
        <div class="col-md-5">
          <img id="confirmationImage" src="" alt="Selected Location" class="img-fluid rounded shadow-sm mb-3" />
          <h2 id="confirmationLocation" class="mb-2"></h5>
          <div class="p-3 rounded shadow-sm bg-white">
            <p><span class="fw-semibold confirmation-titles">Date:</span> <span id="confirmationDate"></span></p>
            <p><span class="fw-semibold confirmation-titles">Time:</span> <span id="confirmationTime"></span></p>
          </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-7">
          <div class="p-3">
            <h3 class="mb-3">Event Details</h5>
            <p><span class="fw-semibold confirmation-titles">Title:</span> <span id="confirmationTitle"></span></p>
            <p><span class="fw-semibold confirmation-titles">Group:</span> <span id="confirmationGroup"></span></p>
            <p><span class="fw-semibold confirmation-titles">Activity Type:</span> <span id="confirmationActivity"></span></p>
            <p><span class="fw-semibold confirmation-titles">Attendees:</span> <span id="confirmationAttendees"></span></p>
            <p><span class="fw-semibold confirmation-titles">Equipment:</span> <span id="confirmationEquipment"></span></p>
            <p><span class="fw-semibold confirmation-titles">Description:</span> <span id="confirmationDescription"></span></p>

            <hr class="my-3">

            <h3 class="mb-3">Organiser Info</h5>
            <p><span class="fw-semibold confirmation-titles">Name:</span> <span id="confirmationOrgName"></span></p>
            <p><span class="fw-semibold confirmation-titles">Email:</span> <span id="confirmationOrgEmail"></span></p>
            <p><span class="fw-semibold confirmation-titles">Phone:</span> <span id="confirmationOrgPhone"></span></p>
            <p><span class="fw-semibold confirmation-titles">Accessibility Help:</span> <span id="confirmationHelp"></span></p>
          </div>
        </div>
      </div>
    </div>
    <!-- Confirm Booking Button -->
    <div class="text-center mt-5">
      <button id="finalConfirmBtn" class="btn btn-custom-continue rounded-pill px-5 py-2 fs-5">
        Confirm Booking
      </button>
    </div>
  </div>

<!-- Booking Confirmed Page -->
<div id="successSection" class="d-none booking-confirmed-container">
  <div class="custom-alert alert-success mb-4">
    ✅ Your booking has been successfully confirmed!
  </div>

  <div class="row g-4 align-items-center">
    <!-- Left: Big image -->
    <div class="col-md-6 text-center">
      <img id="confirmedImage" src="" alt="Selected Location" class="img-fluid rounded shadow-lg" style="max-height: 400px; object-fit: cover; width: 100%;">
    </div>

    <!-- Right: Booking details -->
    <div class="col-md-6">
      <h2 class="mb-4 fw-semibold">Booking Confirmed</h2>
      <p><span class="booking-label fw-semibold">Location:</span> <span id="confirmedLocation"></span></p>
      <p><span class="booking-label fw-semibold">Date:</span> <span id="confirmedDate"></span></p>
      <p><span class="booking-label fw-semibold">Time:</span> <span id="confirmedTime"></span></p>
      <p><span class="booking-label fw-semibold">Event Title:</span> <span id="confirmedTitle"></span></p>
    </div>

    <div class="text-center mt-5">
      <a href="/" class="btn btn-custom-continue rounded-pill px-5 py-2 fs-5">Return to Home Page</a>
      <a href="/booking_manage.html" class="btn btn-custom-continue rounded-pill px-5 py-2 fs-5">Go to Manage Bookings</a>
    </div>
  </div>
</div>
  
<!-- Location Info Modal -->
<div class="modal fade" id="locationInfoModal" tabindex="-1" aria-labelledby="locationInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content p-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 id="locationInfoModalLabel" class="fw-bold mb-0">Location Title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="row gx-4 mb-3">
        <div class="col-md-6">
          <img id="locationInfoImage" src="" alt="Location Image" class="img-fluid rounded" style="object-fit: cover; width: 100%;">
        </div>
        <div class="col-md-6 text-start">
          <h6 class="fw-bold fs-6">Venue Overview:</h6>
          <ul class="mb-0 ps-3" id="venueOverview"></ul>
        </div>
      </div>

      <div class="row">
        <div class="col-12 text-start">
          <h6 class="fw-bold mt-4 fs-6">Facilities Available:</h6>
          <ul class="row ps-3" id="facilitiesList" style="list-style-type: disc; padding-left: 1.5rem;"></ul>

          <h6 class="fw-bold mt-4 fs-6">Booking Guidelines:</h6>
          <ul class="ps-3" id="bookingGuidelines" style="list-style-type: disc;"></ul>

          <h6 class="fw-bold mt-4 fs-6">Suggestions for Best Use:</h6>
          <p id="bestUseText" class="mb-0"></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const continueBtn = document.getElementById("continueBtn");
    const errorMsg = document.getElementById("errorMsg");
    const locationSection = document.getElementById("locationSection");
    const datetimeSection = document.getElementById("datetimeSection");
    const detailsSection = document.getElementById("detailsSection");
    const organiserSection = document.getElementById("organiserSection");
    const tabConfirmation = document.querySelector('[data-tab="confirmation"]');
  
    const stepCircles = [...Array(5).keys()].map(i => document.getElementById(`stepCircle${i}`));
    const progressFill = document.getElementById("progressFill");

    const tabLocation = document.querySelector('[data-tab="location"]');
    const tabDatetime = document.querySelector('[data-tab="datetime"]');
    const tabDetails = document.querySelector('[data-tab="details"]');
    const tabOrganiser = document.querySelector('[data-tab="organiser"]');

    const selectButtons = document.querySelectorAll(".select-btn");
    const cards = document.querySelectorAll(".custom-card");

    
    let currentStep = 0;
    let hasSelectedLocationBefore = false;
    let locationSelected = false;
    let dateSelected = false;
    let timeSelected = false;
    let selectedImageSrc = "";

    stepCircles[0].classList.add("active");
    progressFill.style.width = "0%";

    function updateProgressBar() {
      if (currentStep === 0) {
        progressFill.style.width = locationSelected ? "20%" : "0%";
      } else if (currentStep === 1) {
        if (dateSelected && timeSelected) {
          progressFill.style.width = "45%";
        } else if (dateSelected || timeSelected) {
          progressFill.style.width = "35%";
        } else {
          progressFill.style.width = "25%";
        }
      } else if (currentStep === 2) {
        const count = Object.values(filledFields).filter(Boolean).length;
        progressFill.style.width = `${50 + count * 5}%`;
      } else if (currentStep === 3) {
        const count = Object.values(organiserFilled).filter(Boolean).length;
        progressFill.style.width = `${75 + count * 5}%`;
      } else if (currentStep === 4) {
        progressFill.style.width = "100%";
      }
    }

    function updateStepCircles() {
      stepCircles.forEach((circle, index) => {
        if (index <= currentStep) {
          circle.classList.add("active");
        } else {
          circle.classList.remove("active");
        }
      });
    }

    function updateTabs(tab) {
      tabLocation.classList.remove("active-tab");
      tabDatetime.classList.remove("active-tab");
      tabDetails.classList.remove("active-tab");
      tabOrganiser.classList.remove("active-tab");
      tabConfirmation.classList.remove("active-tab");

      tab.classList.add("active-tab");

      // Hide confirmation only when you're NOT going to it
      if (tab !== tabConfirmation) {
        confirmationSection.classList.add("d-none");
      }
    }

    function showSection(step) {
      locationSection.classList.add("d-none");
      datetimeSection.classList.add("d-none");
      detailsSection.classList.add("d-none");
      organiserSection.classList.add("d-none");

      if (step === 0) locationSection.classList.remove("d-none");
      if (step === 1) datetimeSection.classList.remove("d-none");
      if (step === 2) detailsSection.classList.remove("d-none");
      if (step === 3) organiserSection.classList.remove("d-none");

      updateStepCircles();
      updateProgressBar();
    }

    selectButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        cards.forEach(card => {
          const buttons = card.querySelectorAll(".btn");
          buttons[1].classList.remove("btn-primary");
          buttons[1].classList.add("btn-outline-primary");
          buttons[1].textContent = "Select";
        });

        btn.classList.remove("btn-outline-primary");
        btn.classList.add("btn-primary");
        btn.textContent = "Selected";
        locationSelected = true;
        errorMsg.classList.add("d-none");
        updateProgressBar();

        // ✅ Get the image from the card and store it globally
        const card = btn.closest(".custom-card");
        const img = card.querySelector("img");
        selectedImageSrc = img ? img.getAttribute("src") : "";
        console.log("Selected image src:", selectedImageSrc); // For debugging
      });
    });

    continueBtn.addEventListener("click", () => {
      if (currentStep === 0 && !locationSelected) {
        showAlert("info", "Please select a location before continuing.");
        return;
      }

      if (currentStep === 0) {
        currentStep = 1;
        showSection(currentStep);
        updateTabs(tabDatetime);
      }
    });

    tabLocation.addEventListener("click", () => {
      currentStep = 0;
      updateTabs(tabLocation);
      showSection(currentStep);
      stepCircles.forEach((circle, index) => {
        if (index <= 0) circle.classList.add("active");
        else circle.classList.remove("active");
      });
      progressFill.style.width = locationSelected ? "20%" : "0%";
    });

    tabDatetime.addEventListener("click", () => {
      if (!locationSelected) return;
      currentStep = 1;
      updateTabs(tabDatetime);
      showSection(currentStep);
      stepCircles.forEach((circle, index) => {
        if (index <= 1) circle.classList.add("active");
        else circle.classList.remove("active");
      });
      progressFill.style.width = (dateSelected && timeSelected) ? "45%" : (dateSelected || timeSelected) ? "35%" : "25%";
    });

    tabDetails.addEventListener("click", () => {
      if (!(dateSelected && timeSelected)) return;
      currentStep = 2;
      updateTabs(tabDetails);
      showSection(currentStep);
      const count = Object.values(filledFields).filter(Boolean).length;
      progressFill.style.width = `${50 + count * 5}%`;
      stepCircles.forEach((circle, index) => {
        if (index <= 2) circle.classList.add("active");
        else circle.classList.remove("active");
      });
    });

    tabOrganiser.addEventListener("click", () => {
      const title = titleInput.value.trim();
      const group = groupSelect.value;
      const attendees = attendeesInput.value.trim();
      const activity = activitySelect.value;
      const equipment = document.getElementById("equipment").value.trim();
      const description = document.getElementById("description").value.trim();

      const titleRegex = /^[a-zA-Z0-9\s\.,'-]{3,50}$/;
      const numberRegex = /^[1-9][0-9]*$/;
      const safeTextRegex = /^[^<>]*$/;

      const valid =
        titleRegex.test(title) &&
        group !== "Choose your interest group" &&
        numberRegex.test(attendees) &&
        activity !== "Select an activity type" &&
        safeTextRegex.test(equipment) &&
        safeTextRegex.test(description);

      if (!valid) return;

      currentStep = 3;
      updateTabs(tabOrganiser);
      showSection(currentStep);

      // Hide confirmation section in case coming from step 4
      const confirmationSection = document.getElementById("confirmationSection");
      if (confirmationSection) {
        confirmationSection.classList.add("d-none");
      }

      const count = Object.values(organiserFilled).filter(Boolean).length;
      progressFill.style.width = `${75 + count * 5}%`;

      stepCircles.forEach((circle, index) => {
        if (index <= 3) circle.classList.add("active");
        else circle.classList.remove("active");
      });
    });

    tabConfirmation.addEventListener("click", () => {
      // ✅ Check if ALL prior steps are properly filled
      const allValid =
        locationSelected &&
        dateSelected &&
        timeSelected &&
        filledFields.title &&
        filledFields.group &&
        filledFields.attendees &&
        filledFields.activity &&
        organiserFilled.name &&
        organiserFilled.email &&
        organiserFilled.phone &&
        organiserFilled.help;

      if (!allValid) {
        showAlert("info", "Please complete all previous sections before proceeding to confirmation.");
        return;
      }

      currentStep = 4;
      updateTabs(tabConfirmation);
      updateStepCircles();
      progressFill.style.width = "100%";

      // Show confirmation section
      document.getElementById("confirmationSection").classList.remove("d-none");

      // Hide others
      locationSection.classList.add("d-none");
      datetimeSection.classList.add("d-none");
      detailsSection.classList.add("d-none");
      organiserSection.classList.add("d-none");

      // Refresh summary
      populateConfirmationSummary();
    });

    const titleInput = document.getElementById("eventTitle");
    const groupSelect = document.getElementById("interestGroup");
    const attendeesInput = document.getElementById("attendees");
    const activitySelect = document.getElementById("activityType");

    let filledFields = {
      title: false,
      group: false,
      attendees: false,
      activity: false
    };

    function updateEventDetailsProgress() {
      const count = Object.values(filledFields).filter(Boolean).length;
      progressFill.style.width = `${50 + count * 5}%`;
    }

    titleInput.addEventListener("blur", () => {
      filledFields.title = titleInput.value.trim().length > 0;
      updateEventDetailsProgress();
    });

    groupSelect.addEventListener("change", () => {
      filledFields.group = groupSelect.value !== "Choose your interest group";
      updateEventDetailsProgress();
    });

    attendeesInput.addEventListener("blur", () => {
      filledFields.attendees = /^[1-9][0-9]*$/.test(attendeesInput.value.trim());
      updateEventDetailsProgress();
    });

    activitySelect.addEventListener("change", () => {
      filledFields.activity = activitySelect.value !== "Select an activity type";
      updateEventDetailsProgress();
    });

    const organiserNameInput = document.getElementById("organiserName");
    const organiserEmailInput = document.getElementById("organiserEmail");
    const organiserPhoneInput = document.getElementById("organiserPhone");
    const accessibilityRadios = document.querySelectorAll('input[name="accessibilityHelp"]');

    let organiserFilled = {
      name: false,
      email: false,
      phone: false,
      help: false
    };

    function updateOrganiserProgress() {
      const count = Object.values(organiserFilled).filter(Boolean).length;
      progressFill.style.width = `${75 + count * 5}%`;
    }

    organiserNameInput.addEventListener("blur", () => {
      organiserFilled.name = organiserNameInput.value.trim().length > 0;
      updateOrganiserProgress();
    });

    organiserEmailInput.addEventListener("blur", () => {
      const email = organiserEmailInput.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      organiserFilled.email = emailRegex.test(email);
      updateOrganiserProgress();
    });

    organiserPhoneInput.addEventListener("blur", () => {
      const phone = organiserPhoneInput.value.trim();
      organiserFilled.phone = /^[89]\d{7}$/.test(phone);
      updateOrganiserProgress();
    });

    accessibilityRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        organiserFilled.help = true;
        updateOrganiserProgress();
      });
    });

    const datetimeContinueBtn = document.getElementById("datetimeContinueBtn");
      if (datetimeContinueBtn) {
        datetimeContinueBtn.addEventListener("click", () => {
          if (!dateSelected || !timeSelected) {
            showAlert("info", "Please select both a date and time slot.");
            return;
          }

          currentStep = 2;
          updateStepCircles();
          updateTabs(tabDetails);
          showSection(currentStep); // ✅ This is crucial
          const count = Object.values(filledFields).filter(Boolean).length;
          progressFill.style.width = `${50 + count * 5}%`;
        });
      }

    const detailsContinueBtn = document.getElementById("detailsContinueBtn");
    if (detailsContinueBtn) {
      detailsContinueBtn.addEventListener("click", () => {
        const title = titleInput.value.trim();
        const group = groupSelect.value;
        const attendees = attendeesInput.value.trim();
        const activity = activitySelect.value;
        const equipment = document.getElementById("equipment").value.trim();
        const description = document.getElementById("description").value.trim();

        const titleRegex = /^[a-zA-Z0-9\s\.,'-]{3,50}$/;
        const numberRegex = /^[1-9][0-9]*$/;
        const safeTextRegex = /^[^<>]*$/;

        let msg = "";
        if (!titleRegex.test(title)) msg += "Event title is missing or invalid. ";
        if (group === "Choose your interest group") msg += "Please select an interest group. ";
        if (!numberRegex.test(attendees)) msg += "Please enter a valid number of attendees. ";
        if (activity === "Select an activity type") msg += "Please select an activity type. ";
        if (!safeTextRegex.test(equipment)) msg += "Equipment field contains invalid characters. ";
        if (!safeTextRegex.test(description)) msg += "Description field contains invalid characters. ";

        if (msg) {
          showAlert("error", msg.trim());
          return;
        }

        currentStep = 3;
        updateStepCircles();
        updateTabs(tabOrganiser);
        const count = Object.values(organiserFilled).filter(Boolean).length;
        progressFill.style.width = `${75 + count * 5}%`;
        detailsSection.classList.add("d-none");
        organiserSection.classList.remove("d-none");
      });
    }

    const organiserContinueBtn = document.getElementById("organiserContinueBtn");
    if (organiserContinueBtn) {
      organiserContinueBtn.addEventListener("click", () => {
        const nameValid = organiserNameInput.value.trim().length > 0;

        const email = organiserEmailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const emailValid = emailRegex.test(email);

        const phone = organiserPhoneInput.value.trim();
        const phoneValid = /^[89]\d{7}$/.test(phone);

        const helpSelected = organiserFilled.help; // this already updates on radio change

        let msg = "";
        if (!nameValid) msg += "Please enter your name. ";
        if (!emailValid) msg += "Please enter a valid email address. ";
        if (!phoneValid) msg += "Phone number must start with 8 or 9 and be 8 digits. ";
        if (!helpSelected) msg += "Please select an accessibility assistance option. ";

        if (msg) {
          showAlert("error", msg.trim());
          return;
        }

        // All valid – go to confirmation
        currentStep = 4;
        updateTabs(tabConfirmation);
        updateStepCircles();
        progressFill.style.width = "100%";
        organiserSection.classList.add("d-none");
        document.getElementById("confirmationSection").classList.remove("d-none");

        const equipment = document.getElementById("equipment").value.trim();
        const description = document.getElementById("description").value.trim();

        // === Fill confirmation summary ===
        document.getElementById("confirmationLocation").textContent = selectedLocationName || "-";
        if (selectedCalendarTd) {
          const fullDate = selectedCalendarTd.getAttribute("data-date");
          if (fullDate) {
            const formatted = new Date(fullDate).toLocaleDateString("en-GB", {
              day: "numeric",
              month: "long",
              year: "numeric",
            });
            document.getElementById("confirmationDate").textContent = formatted;
          } else {
            document.getElementById("confirmationDate").textContent = "-";
          }
        } else {
          document.getElementById("confirmationDate").textContent = "-";
        }
        document.getElementById("confirmationTime").textContent = document.querySelector(".time-slot.btn-primary")?.textContent || "-";

        document.getElementById("confirmationTitle").textContent = titleInput.value.trim();
        document.getElementById("confirmationGroup").textContent = groupSelect.value;
        document.getElementById("confirmationActivity").textContent = activitySelect.value;
        document.getElementById("confirmationAttendees").textContent = attendeesInput.value.trim();
        document.getElementById("confirmationEquipment").textContent = equipment || "No value entered";
        document.getElementById("confirmationDescription").textContent = description || "No value entered";

        document.getElementById("confirmationOrgName").textContent = organiserNameInput.value.trim();
        document.getElementById("confirmationOrgEmail").textContent = organiserEmailInput.value.trim();
        document.getElementById("confirmationOrgPhone").textContent = organiserPhoneInput.value.trim();
        document.getElementById("confirmationHelp").textContent = organiserFilled.help ? "Yes" : "No";

        // === Image selection based on location name ===
        const locationImageMap = {
          "Indoor Sports Hall": "{{ url_for('static', filename='images/sports_hall.jpg') }}",
          "Function Room": "{{ url_for('static', filename='images/function_room.jpg') }}",
          "Multi-purpose Hall": "{{ url_for('static', filename='images/multipurpose.jpg') }}"
        };
        document.getElementById("confirmationImage").src = locationImageMap[selectedLocationName] || "{{ url_for('static', filename='images/booking.jpg') }}";
      });
    
    function populateConfirmationSummary() {
      const equipment = document.getElementById("equipment").value.trim();
      const description = document.getElementById("description").value.trim();

      document.getElementById("confirmationLocation").textContent = selectedLocationName || "-";

      if (selectedCalendarTd) {
        const fullDate = selectedCalendarTd.getAttribute("data-date");
        if (fullDate) {
          const formatted = new Date(fullDate).toLocaleDateString("en-GB", {
            day: "numeric",
            month: "long",
            year: "numeric",
          });
          document.getElementById("confirmationDate").textContent = formatted;
        } else {
          document.getElementById("confirmationDate").textContent = "-";
        }
      } else {
        document.getElementById("confirmationDate").textContent = "-";
      }

      document.getElementById("confirmationTime").textContent =
        document.querySelector(".time-slot.btn-primary")?.textContent || "-";

      document.getElementById("confirmationTitle").textContent = titleInput.value.trim();
      document.getElementById("confirmationGroup").textContent = groupSelect.value;
      document.getElementById("confirmationActivity").textContent = activitySelect.value;
      document.getElementById("confirmationAttendees").textContent = attendeesInput.value.trim();
      document.getElementById("confirmationEquipment").textContent = equipment || "No value entered";
      document.getElementById("confirmationDescription").textContent = description || "No value entered";

      document.getElementById("confirmationOrgName").textContent = organiserNameInput.value.trim();
      document.getElementById("confirmationOrgEmail").textContent = organiserEmailInput.value.trim();
      document.getElementById("confirmationOrgPhone").textContent = organiserPhoneInput.value.trim();
      document.getElementById("confirmationHelp").textContent = organiserFilled.help ? "Yes" : "No";

      // Set image
      const locationImageMap = {
        "Indoor Sports Hall": "{{ url_for('static', filename='images/sports_hall.jpg') }}",
        "Function Room": "{{ url_for('static', filename='images/function_room.jpg') }}",
        "Multi-purpose Hall": "{{ url_for('static', filename='images/multipurpose.jpg') }}"
      };
      document.getElementById("confirmationImage").src =
        locationImageMap[selectedLocationName] || "{{ url_for('static', filename='images/booking.jpg') }}";
    }

    function showAlert(type, message) {
      const alertContainer = document.getElementById("customAlertContainer");
      const alert = document.createElement("div");

      let alertClass = "";
      switch (type) {
        case "success":
          alertClass = "alert-success";
          break;
        case "info":
          alertClass = "alert-info";
          break;
        case "warning":
          alertClass = "alert-warning";
          break;
        case "error":
          alertClass = "alert-error";
          break;
        default:
          alertClass = "alert-info";
      }

      alert.className = `custom-alert ${alertClass}`;
      alert.innerHTML = `
        <span>${message}</span>
        <button class="close-btn" onclick="this.parentElement.remove()">×</button>
      `;

      alertContainer.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 5000); // auto-dismiss after 5 seconds
    }
    const finalConfirmBtn = document.getElementById("finalConfirmBtn");
    if (finalConfirmBtn) {
      finalConfirmBtn.addEventListener("click", () => {
        // Hide all previous steps and tabs
        document.querySelector(".tab-container")?.classList.add("d-none");
        document.getElementById("locationSection")?.classList.add("d-none");
        document.getElementById("datetimeSection")?.classList.add("d-none");
        document.getElementById("detailsSection")?.classList.add("d-none");
        document.getElementById("organiserSection")?.classList.add("d-none");
        document.getElementById("confirmationSection")?.classList.add("d-none");

        // Populate confirmation details
        document.getElementById("confirmedLocation").textContent = selectedLocationName || "-";
        document.getElementById("confirmedDate").textContent = document.getElementById("confirmationDate")?.textContent || "-";
        document.getElementById("confirmedTime").textContent = document.getElementById("confirmationTime")?.textContent || "-";
        document.getElementById("confirmedTitle").textContent = titleInput?.value?.trim() || "-";

        // Set location image
        const confirmedImage = document.getElementById("confirmedImage");
          if (confirmedImage && selectedImageSrc) {
            confirmedImage.src = selectedImageSrc;
          }

        // Reveal success page
        document.getElementById("successSection")?.classList.remove("d-none");
        document.getElementById("successSection")?.scrollIntoView({ behavior: "smooth" });

        // Hide progress bar
        document.getElementById("progressWrapper").classList.add("d-none");
      });
    }

    }

    const timeSlots = {
      "Indoor Sports Hall": [
        { label: "8:00 AM – 10:00 AM", period: "morning" },
        { label: "10:30 AM – 12:30 PM", period: "morning" },
        { label: "1:00 PM – 3:00 PM", period: "afternoon" },
        { label: "3:30 PM – 5:30 PM", period: "afternoon" },
        { label: "6:00 PM – 8:00 PM", period: "evening" },
        { label: "8:30 PM – 10:30 PM", period: "evening" }
      ],
      "Function Room": [
        { label: "8:00 AM – 9:00 AM", period: "morning" },
        { label: "9:30 AM – 10:30 AM", period: "morning" },
        { label: "11:00 AM – 12:00 PM", period: "morning" },
        { label: "12:30 PM – 1:30 PM", period: "afternoon" },
        { label: "2:00 PM – 3:00 PM", period: "afternoon" },
        { label: "3:30 PM – 4:30 PM", period: "afternoon" },
        { label: "5:00 PM – 6:00 PM", period: "evening" },
        { label: "6:30 PM – 7:30 PM", period: "evening" },
        { label: "8:00 PM – 9:00 PM", period: "evening" }
      ],
      "Multi-purpose Hall": [
        { label: "8:00 AM – 9:30 AM", period: "morning" },
        { label: "9:45 AM – 11:15 AM", period: "morning" },
        { label: "11:30 AM – 1:00 PM", period: "morning" },
        { label: "1:15 PM – 2:45 PM", period: "afternoon" },
        { label: "3:00 PM – 4:30 PM", period: "afternoon" },
        { label: "4:45 PM – 6:15 PM", period: "afternoon" },
        { label: "6:30 PM – 8:00 PM", period: "evening" },
        { label: "8:15 PM – 9:45 PM", period: "evening" }
      ]
    };

    let selectedLocationName = null;

    selectButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        // Reset styles for all buttons
        cards.forEach(card => {
          const buttons = card.querySelectorAll(".btn");
          buttons[1].classList.remove("btn-primary");
          buttons[1].classList.add("btn-outline-primary");
          buttons[1].textContent = "Select";
        });

        // Style this selected one
        btn.classList.remove("btn-outline-primary");
        btn.classList.add("btn-primary");
        btn.textContent = "Selected";

        // Save new location name
        const newLocation = btn.closest(".custom-card").querySelector("h5").innerText;

        // 💡 If location is changing, reset datetime-related selections
        if (selectedLocationName !== newLocation) {
          selectedLocationName = newLocation;

          // Reset date & time
          selectedCalendarTd?.classList.remove("bg-primary", "text-white");
          selectedCalendarTd = null;
          dateSelected = false;
          timeSelected = false;

          // Remove styling and content
          document.querySelectorAll(".time-slot").forEach(slot => slot.classList.remove("btn-primary"));
          ["morningSlotButtons", "afternoonSlotButtons", "eveningSlotButtons"].forEach(id => {
            document.getElementById(id).innerHTML = "";
          });
          ["morningSlots", "afternoonSlots", "eveningSlots"].forEach(id => {
            document.getElementById(id).classList.add("d-none");
          });

          // Repopulate with new timeslots and reset calendar
          populateTimeSlots(selectedLocationName);
          renderCalendar(calendarDate);

          // 🛑 Only show this alert if location was previously selected
          if (hasSelectedLocationBefore) {
            showAlert("info", "Location changed. Please reselect your date and time.");
          }

          hasSelectedLocationBefore = true; // Mark as not first-time
        }

        locationSelected = true;
        errorMsg.classList.add("d-none");
        updateProgressBar();
      });
    });

    function populateTimeSlots(location) {
      const slots = timeSlots[location];
      const sections = {
        morning: document.getElementById("morningSlotButtons"),
        afternoon: document.getElementById("afternoonSlotButtons"),
        evening: document.getElementById("eveningSlotButtons")
      };

      Object.keys(sections).forEach(period => {
        sections[period].innerHTML = "";
        document.getElementById(period + "Slots").classList.add("d-none");
      });

      slots.forEach(slot => {
        const btn = document.createElement("button");
        btn.className = "btn btn-outline-dark time-slot";
        btn.innerText = slot.label;
        btn.addEventListener("click", () => {
          document.querySelectorAll(".time-slot").forEach(b => b.classList.remove("btn-primary"));
          btn.classList.add("btn-primary");
          timeSelected = true;
          updateProgressBar();
        });
        sections[slot.period].appendChild(btn);
        document.getElementById(slot.period + "Slots").classList.remove("d-none");
      });
    }

    // === Calendar ===
    const calendarBody = document.getElementById("calendar-body");
    const monthYear = document.getElementById("monthYear");
    const prevMonth = document.getElementById("prevMonth");
    const nextMonth = document.getElementById("nextMonth");

    let selectedCalendarTd = null;
    let calendarDate = new Date();

    function renderCalendar(date) {
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      monthYear.textContent = date.toLocaleString("default", {
        month: "long",
        year: "numeric"
      });

      const isCurrentMonth = year === today.getFullYear() && month === today.getMonth();
      prevMonth.style.visibility = isCurrentMonth ? "hidden" : "visible";

      let html = "", day = 1;
      for (let i = 0; i < 6; i++) {
        html += "<tr>";
        for (let j = 0; j < 7; j++) {
          if (i === 0 && j < firstDay) html += "<td></td>";
          else if (day > daysInMonth) html += "<td></td>";
          else {
            const thisDate = new Date(year, month, day);
            thisDate.setHours(0, 0, 0, 0);
            const isPast = thisDate < today;
            const className = isPast ? "text-muted disabled-date" : "calendar-day";
            const dataAttr = isPast ? "" : `data-date="${year}-${month + 1}-${day}"`;
            const paddedMonth = String(month + 1).padStart(2, '0');
            const paddedDay = String(day).padStart(2, '0');
            const fullDateStr = `${year}-${paddedMonth}-${paddedDay}`;

            html += `<td class="${className}" data-date="${fullDateStr}">${day}</td>`;
            day++;
          }
        }
        html += "</tr>";
      }

      calendarBody.innerHTML = html;

      document.querySelectorAll(".calendar-day").forEach(cell => {
        cell.addEventListener("click", () => {
          if (selectedCalendarTd) selectedCalendarTd.classList.remove("bg-primary", "text-white");
          cell.classList.add("bg-primary", "text-white");
          selectedCalendarTd = cell;
          dateSelected = true;
          updateProgressBar();
        });
      });
    }

    prevMonth.addEventListener("click", () => {
      const tempDate = new Date(calendarDate);
      tempDate.setMonth(calendarDate.getMonth() - 1);
      const today = new Date();
      if (tempDate < today) return;
      calendarDate.setMonth(calendarDate.getMonth() - 1);
      renderCalendar(calendarDate);
    });

    nextMonth.addEventListener("click", () => {
      calendarDate.setMonth(calendarDate.getMonth() + 1);
      renderCalendar(calendarDate);
    });

    renderCalendar(calendarDate);
  });
</script>

{% endblock %}
